<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital TV App UI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Material Symbols Rounded -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- HLS.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* Updated Background Gradient */
            background: radial-gradient(66.56% 118.33% at 33.44% 31.3%, rgb(64, 64, 64) 0%, rgb(25, 25, 25) 100%);
            color: #ffffff;
            width: 100%;
            background-attachment: fixed; /* Giữ gradient cố định khi cuộn */
        }

        html {
            scroll-behavior: smooth;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- NAVIGATION STYLES (Header & Tabs) --- */
        .nav-transition {
            transition: all 0.3s ease-in-out;
        }

        /* Trạng thái mặc định */
        .nav-default {
            background-color: transparent;
            border-bottom-color: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            box-shadow: none;
        }

        /* Trạng thái khi Scroll */
        .nav-scrolled {
            background-color: transparent; /* Đã đổi từ rgba(5, 5, 6, 0.7) sang transparent */
            backdrop-filter: saturate(180%) blur(1.25rem);
            -webkit-backdrop-filter: saturate(180%) blur(1.25rem);
            border-bottom-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* === CUSTOM PLAYER STYLES === */
        .material-symbols-rounded {
            font-size: 24px;
            font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .control-glass {
            background: rgba(25, 25, 25, 0.6); /* #191919 with opacity */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        input[type=range].custom-range {
            -webkit-appearance: none;
            background: transparent;
            height: 4px;
            cursor: pointer;
        }
        input[type=range].custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #ffffff; /* Thumb White */
            margin-top: -4px;
            transition: transform 0.1s;
        }
        input[type=range].custom-range:hover::-webkit-slider-thumb { transform: scale(1.5); }
        input[type=range].custom-range::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .quality-menu {
            bottom: 100%;
            right: 0;
            margin-bottom: 10px;
            background: #191919; /* Menu Surface #191919 */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            display: none;
            flex-direction: column;
            min-width: 120px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .quality-menu.show { display: flex; }
        .quality-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quality-item:hover { background: rgba(255,255,255,0.05); }
        .quality-item.active { color: #ffffff; font-weight: 600; background: rgba(255,255,255,0.1); } 

        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }

        /* === TABS & GRID STYLES === */
        .tab-item {
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        /* Active Tab: Accent White #ffffff, Text Black */
        .tab-item.active {
            background-color: #ffffff; 
            color: #000000;
            border: 1px solid #ffffff; 
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.2);
        }
        .tab-item:not(.active):hover { 
            background-color: rgba(255, 255, 255, 0.1); 
            border-color: rgba(255,255,255,0.2);
        }

        .channel-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1rem;
        }

        @media (min-width: 640px) { .channel-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        @media (min-width: 768px) { .channel-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1.5rem; } }
        @media (min-width: 1024px) { .channel-grid { grid-template-columns: repeat(5, minmax(0, 1fr)); } }
        @media (min-width: 1280px) { .channel-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); } }
        
        .player-wrapper {
            height: calc(100vh - 10rem); 
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        /* UPDATED: Tab Container Background fixed to match body */
        #tabs-container {
            background: radial-gradient(66.56% 118.33% at 33.44% 31.3%, rgb(64, 64, 64) 0%, rgb(25, 25, 25) 100%);
            background-attachment: fixed;
        }

    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header (h-16 = 4rem) -->
    <!-- Sử dụng class nav-default nav-transition thay vì border cứng -->
    <header id="app-header" class="fixed top-0 w-full z-50 h-16 border-b nav-default nav-transition">
        <div class="w-full px-[5%] h-full flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
                <!-- Logo: BG White, Icon Black -->
                <div class="w-8 h-8 bg-white rounded flex items-center justify-center border border-white/10 shadow-sm">
                    <i class="fas fa-play text-black text-xs"></i>
                </div>
                <span class="text-xl font-bold tracking-tight text-white">VNTV<span class="text-white/50">Go</span></span>
            </div>
            <nav class="hidden md:flex space-x-8 text-sm font-medium text-white/60">
                <a href="#" class="text-white hover:text-white transition">Trang chủ</a>
                <a href="#" class="hover:text-white transition">Truyền hình</a>
                <a href="#" class="hover:text-white transition">Phim truyện</a>
                <a href="#" class="hover:text-white transition">Thể thao</a>
            </nav>
            <div class="flex items-center gap-4">
                <button class="text-white/60 hover:text-white transition"><i class="fas fa-search"></i></button>
                <div class="w-8 h-8 rounded-full bg-[#191919] overflow-hidden border border-white/10 cursor-pointer">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User">
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow pt-16 w-full px-[5%] flex flex-col">
        
        <!-- MAIN 1: PLAYER AREA -->
        <section id="main-1" class="w-full flex-shrink-0 mt-4">
            <div class="player-wrapper">
                <!-- Video Container -->
                <!-- UPDATED: 
                     1. Thêm 'flex justify-center items-center' để video luôn căn giữa, không bị lệch top/left.
                     2. Đổi 'bg-[#000000]' thành 'bg-transparent' để loại bỏ thanh đen nếu video không khít.
                     3. 'aspect-video' là mặc định, JS sẽ ghi đè nếu tỷ lệ video khác.
                -->
                <div id="video-container" class="relative w-auto h-auto max-w-full max-h-full aspect-video bg-transparent overflow-hidden shadow-2xl border border-white/10 group select-none rounded-xl flex justify-center items-center">
                    <div id="video-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-transparent z-10">
                        <div class="text-center">
                            <i class="fas fa-circle-notch fa-spin text-4xl text-white mb-4"></i>
                            <p id="loading-text" class="text-white/50 text-sm">Đang tải dữ liệu...</p>
                        </div>
                    </div>
                    
                    <!-- object-contain: Video sẽ hiển thị trọn vẹn, không bị cắt -->
                    <video id="main-video-player" class="w-full h-full object-contain cursor-pointer" playsinline poster=""></video>

                    <div id="custom-controls" class="absolute inset-0 z-20 flex flex-col justify-end p-4 opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-gradient-to-t from-black/90 via-black/30 to-transparent">
                        <div class="w-full mb-4 px-1 group/progress relative h-4 flex items-center cursor-pointer">
                             <div class="absolute w-full h-1 bg-white/20 rounded-full overflow-hidden">
                                 <div id="buffer-bar" class="absolute left-0 top-0 h-full bg-white/30 w-0 transition-all duration-300"></div>
                                 <div id="progress-bar" class="absolute left-0 top-0 h-full bg-white w-0"></div> 
                             </div>
                             <div id="progress-thumb" class="absolute w-3 h-3 bg-white rounded-full shadow opacity-0 group-hover/progress:opacity-100 transition-opacity" style="left: 0%"></div>
                             <input type="range" id="seek-slider" min="0" max="100" value="0" step="0.1" class="absolute w-full h-full opacity-0 cursor-pointer z-10">
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="flex items-center gap-3">
                                <button id="play-btn" class="control-glass w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 text-white transition flex-shrink-0">
                                    <span class="material-symbols-rounded">play_arrow</span>
                                </button>
                                <div class="group/vol control-glass h-10 rounded-full flex items-center transition-all duration-300 ease-out w-10 hover:w-[160px] overflow-hidden">
                                    <button id="mute-btn" class="w-10 h-10 flex items-center justify-center hover:bg-white/10 text-white transition z-10 relative flex-shrink-0">
                                        <span class="material-symbols-rounded">volume_up</span>
                                    </button>
                                    <div class="w-0 group-hover/vol:w-[110px] overflow-hidden transition-all duration-300 h-full flex items-center opacity-0 group-hover/vol:opacity-100 pr-3 pl-1">
                                        <input type="range" id="volume-slider" class="custom-range w-full" min="0" max="1" step="0.05" value="1">
                                    </div>
                                </div>
                                <div class="control-glass px-4 h-10 rounded-full flex items-center justify-center font-mono text-sm text-gray-300 select-none">
                                    <span id="current-time">00:00</span> <span class="text-white/40 mx-1">/</span> <span id="duration">00:00</span>
                                </div>
                                
                                <!-- Speed Indicator Added Here -->
                                <button id="speed-indicator" class="control-glass px-3 h-10 rounded-full flex items-center justify-center font-mono text-xs text-white/70 hover:text-white transition cursor-pointer min-w-[70px] select-none" title="Chuyển đổi Kb/s - Mb/s">
                                    0 Kb/s
                                </button>
                            </div>
                            <div class="control-glass rounded-2xl flex items-center relative h-10">
                                <div class="relative h-full">
                                    <button id="quality-btn" class="w-12 h-full flex items-center justify-center hover:bg-white/10 text-white rounded-l-2xl transition" title="Chất lượng">
                                        <span class="material-symbols-rounded">settings</span>
                                    </button>
                                    <div id="quality-menu" class="quality-menu absolute">
                                        <div class="quality-item active" data-level="-1">
                                            <span>Auto</span>
                                            <span class="material-symbols-rounded text-sm ml-2">check</span>
                                        </div>
                                    </div>
                                </div>
                                <button id="pip-btn" class="w-12 h-full flex items-center justify-center hover:bg-white/10 text-white transition" title="Hình trong hình">
                                    <span class="material-symbols-rounded">picture_in_picture_alt</span>
                                </button>
                                <button id="fullscreen-btn" class="w-12 h-full flex items-center justify-center hover:bg-white/10 text-white rounded-r-2xl transition" title="Toàn màn hình">
                                    <span class="material-symbols-rounded">fullscreen</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MAIN 2: LISTS WITH PILL TABS -->
        <section id="main-2" class="flex-grow flex flex-col">
            <!-- Tabs container -->
            <!-- Đã bỏ sticky top-16 z-40 để tab cuộn theo trang -->
            <div id="tabs-container" class="relative flex items-center -mx-[5%] px-[5%] border-b pt-6 pb-2 cursor-pointer nav-default nav-transition">
                 <div id="category-tabs" class="flex gap-3 overflow-x-auto scrollbar-hide w-full items-center">
                    <button class="tab-item active px-5 py-2 rounded-full bg-white text-sm font-medium border border-white hover:bg-white text-black flex-shrink-0">
                        Đang tải...
                    </button>
                 </div>
            </div>

            <div id="loading-state" class="text-center py-12">
                <i class="fas fa-circle-notch fa-spin text-3xl text-white"></i>
                <p class="text-white/50 mt-2">Đang đồng bộ danh sách kênh...</p>
            </div>
            
            <div id="empty-state" class="text-center text-white/40 py-10 hidden">
                <p id="error-message">Không thể tải dữ liệu kênh</p>
            </div>

            <div id="channel-list-wrapper" class="animate-fade-in pt-6 pb-10">
                <div id="channel-grid" class="channel-grid"></div>
            </div>
        </section>
    </main>

    <footer class="bg-transparent border-t border-white/10 py-8 mt-auto">
        <div class="container mx-auto px-4 text-center text-white/30 text-sm">
            <p>&copy; 2024 VNTVGo Clone.</p>
        </div>
    </footer>

    <script>
        const DATA_URL = 'https://raw.githubusercontent.com/nnam0308/iptv/main/data/data.json';
        let allChannels = [];
        let uniqueGroups = new Set();
        let currentGroup = 'Tất cả';
        let hls = null;
        let speedInterval = null;
        let speedUnit = 'kb'; // 'kb' or 'mb'
        
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('main-video-player');
        const playBtn = document.getElementById('play-btn');
        const muteBtn = document.getElementById('mute-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const seekSlider = document.getElementById('seek-slider');
        const progressBar = document.getElementById('progress-bar');
        const progressThumb = document.getElementById('progress-thumb');
        const bufferBar = document.getElementById('buffer-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const pipBtn = document.getElementById('pip-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const qualityBtn = document.getElementById('quality-btn');
        const qualityMenu = document.getElementById('quality-menu');
        const tabsContainer = document.getElementById('tabs-container');
        const header = document.getElementById('app-header'); // Lấy element header
        const speedIndicator = document.getElementById('speed-indicator'); // Speed Indicator Element
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}:${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
            return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
        }

        function togglePlay() {
            if (video.paused || video.ended) { video.play(); } else { video.pause(); }
        }
        playBtn.addEventListener('click', togglePlay);
        video.addEventListener('click', togglePlay);
        video.addEventListener('play', () => { playBtn.innerHTML = '<span class="material-symbols-rounded">pause</span>'; });
        video.addEventListener('pause', () => { playBtn.innerHTML = '<span class="material-symbols-rounded">play_arrow</span>'; });

        function updateVolumeIcon() {
            const val = video.volume;
            if (video.muted || val === 0) { muteBtn.innerHTML = '<span class="material-symbols-rounded">volume_off</span>'; }
            else if (val < 0.5) { muteBtn.innerHTML = '<span class="material-symbols-rounded">volume_down</span>'; }
            else { muteBtn.innerHTML = '<span class="material-symbols-rounded">volume_up</span>'; }
        }
        volumeSlider.addEventListener('input', (e) => {
            video.volume = e.target.value;
            video.muted = false;
            updateVolumeIcon();
        });
        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            if (video.muted) volumeSlider.value = 0;
            else volumeSlider.value = video.volume;
            updateVolumeIcon();
        });

        // Speed Toggle Logic
        speedIndicator.addEventListener('click', (e) => {
            e.stopPropagation();
            speedUnit = speedUnit === 'kb' ? 'mb' : 'kb';
            updateSpeedDisplay(); // Force update immediately
        });

        function updateSpeedDisplay() {
            if (!hls) {
                speedIndicator.textContent = "N/A";
                return;
            }
            
            // hls.bandwidthEstimate returns bits per second
            const bandwidth = hls.bandwidthEstimate;
            
            if (!bandwidth || isNaN(bandwidth)) {
                speedIndicator.textContent = `0 ${speedUnit === 'kb' ? 'Kb/s' : 'Mb/s'}`;
                return;
            }

            let displayValue = 0;
            if (speedUnit === 'kb') {
                // Convert bits to kilobits
                displayValue = (bandwidth / 1024).toFixed(0);
                speedIndicator.textContent = `${displayValue} Kb/s`;
            } else {
                // Convert bits to megabits
                displayValue = (bandwidth / 1024 / 1024).toFixed(2);
                speedIndicator.textContent = `${displayValue} Mb/s`;
            }
        }

        // 3. Time Update
        video.addEventListener('timeupdate', () => {
            const current = video.currentTime;
            const duration = video.duration || 0;
            currentTimeEl.textContent = formatTime(current);
            if (!isNaN(duration) && duration !== Infinity) {
                durationEl.textContent = formatTime(duration);
                const pct = (current / duration) * 100;
                progressBar.style.width = `${pct}%`;
                progressThumb.style.left = `${pct}%`;
                seekSlider.value = pct;
            } else {
                durationEl.textContent = "LIVE";
                progressBar.style.width = '100%';
                progressThumb.style.left = '100%';
            }
        });

        // --- NEW: AUTO ASPECT RATIO FIX ---
        // Khi video tải thông tin, tự động chỉnh khung chứa vừa khít với tỷ lệ video
        video.addEventListener('loadedmetadata', () => {
            if (video.videoWidth && video.videoHeight) {
                const ratio = video.videoWidth / video.videoHeight;
                videoContainer.style.aspectRatio = `${ratio}`;
            }
            // Ẩn placeholder khi đã có kích thước
            document.getElementById('video-placeholder').classList.add('hidden');
        });

        seekSlider.addEventListener('input', (e) => {
            const duration = video.duration;
            if (!isNaN(duration) && duration !== Infinity) {
                const seekTo = (e.target.value / 100) * duration;
                video.currentTime = seekTo;
            }
        });
        video.addEventListener('progress', () => {
            const duration = video.duration;
            if (duration > 0 && video.buffered.length > 0) {
                const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                const pct = (bufferedEnd / duration) * 100;
                bufferBar.style.width = `${pct}%`;
            }
        });

        pipBtn.addEventListener('click', async () => {
            try {
                if (document.pictureInPictureElement) { await document.exitPictureInPicture(); }
                else if (document.pictureInPictureEnabled) { await video.requestPictureInPicture(); }
            } catch (error) { console.error(error); }
        });
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) { videoContainer.requestFullscreen().catch(err => console.log(err)); }
            else { document.exitFullscreen(); }
        });
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) { fullscreenBtn.innerHTML = '<span class="material-symbols-rounded">close_fullscreen</span>'; }
            else { fullscreenBtn.innerHTML = '<span class="material-symbols-rounded">fullscreen</span>'; }
        });

        qualityBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            qualityMenu.classList.toggle('show');
        });
        document.addEventListener('click', (e) => {
            if (!qualityBtn.contains(e.target) && !qualityMenu.contains(e.target)) { qualityMenu.classList.remove('show'); }
        });

        // --- SCROLL LOGIC & INTERACTION ---
        
        // 1. Scroll Effect for Header & Tabs
        function handleScrollEffect() {
            if (window.scrollY > 10) {
                header.classList.remove('nav-default');
                header.classList.add('nav-scrolled');
                
                // Tabs container không còn sticky nên không cần hiệu ứng scroll
                // tabsContainer.classList.remove('nav-default');
                // tabsContainer.classList.add('nav-scrolled');
            } else {
                header.classList.add('nav-default');
                header.classList.remove('nav-scrolled');
                
                // tabsContainer.classList.add('nav-default');
                // tabsContainer.classList.remove('nav-scrolled');
            }
        }
        window.addEventListener('scroll', handleScrollEffect);

        // 2. Scroll To Main on Interaction
        function scrollToMain() {
             const main2 = document.getElementById('main-2');
             const offset = 64; 
             const bodyRect = document.body.getBoundingClientRect().top;
             const elementRect = main2.getBoundingClientRect().top;
             const elementPosition = elementRect - bodyRect;
             const offsetPosition = elementPosition - offset;

             window.scrollTo({
                  top: offsetPosition,
                  behavior: "smooth"
             });
        }

        tabsContainer.addEventListener('click', (e) => {
            // Click outside buttons (on container background)
            if (e.target.id === 'tabs-container' || e.target.id === 'category-tabs') {
                scrollToMain();
            }
        });

        async function initApp() {
            try {
                const response = await fetch(DATA_URL);
                const rawData = await response.json();
                processData(rawData);
            } catch (error) {
                console.error("Lỗi:", error);
                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            }
        }

        function processData(data) {
            allChannels = data;
            uniqueGroups = new Set();
            data.forEach(channel => {
                const groups = channel.group ? channel.group.split(',').map(g => g.trim()) : ['Khác'];
                groups.forEach(g => uniqueGroups.add(g));
            });
            document.getElementById('loading-state').classList.add('hidden');
            renderTabs();
            renderChannelGrid('Tất cả');
            if (allChannels.length > 0) { updatePlayer(allChannels[0]); }
        }

        function renderTabs() {
            const tabsWrapper = document.getElementById('category-tabs');
            tabsWrapper.innerHTML = '';
            const allBtn = document.createElement('button');
            // Active: BG White, Text Black. Inactive: Text Gray, Hover Light White
            allBtn.className = `tab-item px-5 py-2 rounded-full text-sm font-medium border border-transparent cursor-pointer flex-shrink-0 ${currentGroup === 'Tất cả' ? 'active' : 'text-white/60 border-white/5 hover:bg-white/10 hover:text-white'}`;
            allBtn.textContent = 'Tất cả';
            allBtn.onclick = (e) => { 
                e.stopPropagation(); 
                switchTab('Tất cả', allBtn); 
            };
            tabsWrapper.appendChild(allBtn);
            Array.from(uniqueGroups).sort().forEach(group => {
                const btn = document.createElement('button');
                btn.className = `tab-item px-5 py-2 rounded-full text-sm font-medium border border-transparent cursor-pointer flex-shrink-0 ${currentGroup === group ? 'active' : 'text-white/60 border-white/5 hover:bg-white/10 hover:text-white'}`;
                btn.textContent = group;
                btn.onclick = (e) => { 
                    e.stopPropagation(); 
                    switchTab(group, btn); 
                };
                tabsWrapper.appendChild(btn);
            });
        }

        function switchTab(groupName, clickedBtn) {
            currentGroup = groupName;
            const buttons = document.querySelectorAll('.tab-item');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-white/60', 'border-white/5', 'hover:bg-white/10', 'hover:text-white');
            });
            clickedBtn.classList.remove('text-white/60', 'border-white/5', 'hover:bg-white/10', 'hover:text-white');
            clickedBtn.classList.add('active');
            
            renderChannelGrid(groupName);
            scrollToMain();
        }

        function renderChannelGrid(filterGroup) {
            const grid = document.getElementById('channel-grid');
            grid.innerHTML = '';
            const filteredChannels = filterGroup === 'Tất cả' 
                ? allChannels 
                : allChannels.filter(ch => {
                    const groups = ch.group ? ch.group.split(',').map(g => g.trim()) : ['Khác'];
                    return groups.includes(filterGroup);
                });
            if (filteredChannels.length === 0) {
                grid.innerHTML = '<p class="text-white/50 col-span-full text-center py-8">Không tìm thấy kênh nào.</p>';
                return;
            }
            filteredChannels.forEach(channel => { grid.appendChild(createChannelCard(channel)); });
        }

        function createChannelCard(channel) {
            const card = document.createElement('div');
            // Card BG: #191919
            card.className = "bg-[#191919] rounded-xl overflow-hidden cursor-pointer hover:scale-105 hover:shadow-xl transition-all duration-300 border border-white/5 group relative";
            const logoUrl = channel.image?.url || '';
            const logoHtml = logoUrl && logoUrl.length > 5
                ? `<img src="${logoUrl}" class="w-20 h-20 object-contain drop-shadow-md group-hover:scale-110 transition-transform duration-300" onerror="this.style.display='none'">`
                : `<span class="text-3xl font-bold text-white/40 group-hover:text-white">${channel.name.charAt(0)}</span>`;
            card.innerHTML = `
                <div class="h-32 bg-gradient-to-br from-[#191919] to-[#050506] flex items-center justify-center relative p-4">
                    ${logoHtml}
                    <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm">
                        <!-- Play Icon: BG White (#ffffff), Icon Black -->
                        <div class="w-12 h-12 bg-white border border-white/10 rounded-full flex items-center justify-center"><i class="fas fa-play text-black"></i></div>
                    </div>
                </div>
                <div class="p-3 bg-[#191919] border-t border-white/5">
                    <h3 class="font-bold text-gray-200 text-sm truncate">${channel.name}</h3>
                </div>
            `;
            card.onclick = () => updatePlayer(channel);
            return card;
        }

        function updatePlayer(channel) {
            const streamUrl = channel.stream_links?.url;
            const placeholder = document.getElementById('video-placeholder');
            const loadingText = document.getElementById('loading-text');
            
            // Clear previous speed interval if exists
            if (speedInterval) clearInterval(speedInterval);
            speedIndicator.textContent = `0 ${speedUnit === 'kb' ? 'Kb/s' : 'Mb/s'}`;

            if (!streamUrl) return;

            placeholder.classList.remove('hidden');
            loadingText.textContent = `Đang kết nối tới ${channel.name}...`;
            qualityMenu.innerHTML = '';
            
            if (Hls.isSupported()) {
                if (hls) hls.destroy();
                hls = new Hls({ enableWorker: true, lowLatencyMode: true });
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    placeholder.classList.add('hidden');
                    video.play().catch(()=>{});
                    generateQualityLevels(hls.levels);
                    
                    // Start speed update interval
                    speedInterval = setInterval(updateSpeedDisplay, 1000);
                });
                hls.on(Hls.Events.ERROR, (e, data) => {
                    if (data.fatal) {
                        if (data.type === Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad();
                        else hls.destroy();
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', () => {
                    placeholder.classList.add('hidden');
                    video.play();
                });
            }
        }

        function generateQualityLevels(levels) {
            qualityMenu.innerHTML = '';
            const autoItem = document.createElement('div');
            autoItem.className = 'quality-item active';
            autoItem.innerHTML = '<span>Auto</span><span class="material-symbols-rounded text-sm ml-2">check</span>';
            autoItem.onclick = () => { hls.currentLevel = -1; updateQualityUI(-1); };
            qualityMenu.appendChild(autoItem);
            levels.forEach((level, index) => {
                const item = document.createElement('div');
                item.className = 'quality-item';
                const height = level.height ? `${level.height}p` : `Level ${index}`;
                item.innerHTML = `<span>${height}</span>`; 
                item.onclick = () => { hls.currentLevel = index; updateQualityUI(index); };
                qualityMenu.appendChild(item);
            });
        }

        function updateQualityUI(selectedIndex) {
            const items = qualityMenu.querySelectorAll('.quality-item');
            items.forEach((item, index) => {
                const isAuto = selectedIndex === -1 && index === 0;
                const isMatch = index === (selectedIndex + 1);
                if (isAuto || isMatch) {
                    item.classList.add('active');
                    if (!item.querySelector('.material-symbols-rounded')) {
                        item.innerHTML += '<span class="material-symbols-rounded text-sm ml-2">check</span>';
                    }
                } else {
                    item.classList.remove('active');
                    const icon = item.querySelector('.material-symbols-rounded');
                    if (icon) icon.remove();
                }
            });
            qualityMenu.classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
